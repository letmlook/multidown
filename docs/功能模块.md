# Multidown 功能模块设计

> 对标 IDM 的下载工具 · 功能模块独立整理与完善

---

## 一、模块总览

### 1.1 一级模块与依赖关系

```
                    ┌─────────────────┐
                    │   用户界面 UI    │
                    └────────┬────────┘
                             │ 调用
         ┌───────────────────┼───────────────────┐
         ▼                   ▼                   ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│   下载引擎 Core  │ │  协议与网络     │ │  浏览器集成      │
│  (任务/分段/写入) │ │  HTTP/代理/认证  │ │  (可选)          │
└────────┬────────┘ └────────┬────────┘ └─────────────────┘
         │                    │
         └──────────┬─────────┘
                    ▼
         ┌─────────────────┐
         │  扩展能力        │
         │  批量/规则/计划   │
         └─────────────────┘
```

| 模块 | 说明 | 实现优先级 | 主要技术层 |
|------|------|------------|-------------|
| **下载引擎** | 多连接、分段、断点续传、任务调度 | P0 必须 | Rust |
| **协议与网络** | HTTP(S)、Range、代理、认证 | P0 必须 | Rust |
| **用户界面** | 任务列表、新建任务、设置、通知 | P0 必须 | React + Tauri |
| **浏览器集成** | 扩展抓链、与主程序通信 | P1 重要 | 扩展 + Rust/TS |
| **扩展能力** | 批量、规则、定时、分类 | P2 增强 | Rust + React |

### 1.2 与项目目录的对应关系（Multidown）

| 功能模块 | 建议代码位置 | 说明 |
|----------|--------------|------|
| 下载引擎 | `src-tauri/src/engine/` | 协议探测、任务、分段、连接、写入、持久化 |
| 协议与网络 | `src-tauri/src/network/` 或合入 engine | HTTP 客户端、代理、认证 |
| 用户界面 | `src/`（React 组件） | 页面、设置页、托盘/通知通过 Tauri 插件 |
| 浏览器集成 | 独立仓库或 `integration/` | 扩展源码 + Native Messaging Host（Rust） |
| 扩展能力 | `src-tauri/src/` + `src/` | 批量逻辑在 Rust，规则配置在前后端 |

---

## 二、下载引擎（Core）

### 2.1 模块职责

负责「单个下载任务」的完整生命周期：从 URL 到完整文件，支持多连接、分段、暂停/恢复、取消，并持久化进度。

### 2.2 子模块拆解

#### 2.2.1 协议探测（Probe）

| 项目 | 内容 |
|------|------|
| **职责** | 判断是否支持 Range、获取文件总大小、建议文件名、重定向与最终 URL |
| **输入** | URL、可选请求头（Cookie、Referer、User-Agent） |
| **输出** | 是否支持 Range、总字节数、建议文件名、最终 URL、可选 ETag/Last-Modified |
| **实现要点** | 先发 HEAD；无 Content-Length 时用 GET + Range: bytes=0-0 取首字节并读 Content-Range；从 Content-Disposition 或 URL 解析文件名 |
| **接口形态** | Rust: `probe(url, options) -> Result<ProbeResult>`；可暴露为 Tauri command 供前端“新建任务”预填 |

#### 2.2.2 任务调度（Scheduler）

| 项目 | 内容 |
|------|------|
| **职责** | 任务的创建、暂停、恢复、取消；多任务并发数限制；任务队列与状态机 |
| **输入** | 用户操作（新建/暂停/恢复/取消）、全局配置（最大并发任务数、每任务最大连接数） |
| **输出** | 任务状态变更事件、进度（已下载字节、速度、剩余时间估算） |
| **实现要点** | 每任务一个状态机：Pending → Downloading → Paused / Completed / Failed / Cancelled；全局限制同时 Downloading 的任务数；进度用事件或轮询推给前端 |
| **接口形态** | Rust: `create_task`, `pause_task`, `resume_task`, `cancel_task`；任务列表与进度通过 Tauri 事件或 invoke 查询 |

#### 2.2.3 分段策略（Segmentation）

| 项目 | 内容 |
|------|------|
| **职责** | 决定如何把“未下载区间”拆成多段、每段分配给哪个连接；支持静态分段与动态分段 |
| **输入** | 文件总大小、未完成区间列表、当前空闲连接数、是否支持 Range |
| **输出** | 为每个连接分配 [start, end) 或“无” |
| **实现要点** | **静态**：总大小 / N 得到 N 段，按段分配。**动态**：维护未完成区间；空闲连接时找“当前最大段”，对半切，新连接拿后半段；某连接完成后可复用去“帮最慢的段”再对半切 |
| **接口形态** | Rust 内部模块，被“连接管理”调用，不直接暴露给前端 |

#### 2.2.4 连接管理（Connection Manager）

| 项目 | 内容 |
|------|------|
| **职责** | 为任务创建多条 HTTP 连接、为每条连接分配/回收段、超时重试、连接复用 |
| **输入** | 任务元信息（URL、header、代理）、分段策略给出的 [start, end)、取消/暂停信号 |
| **输出** | 各段数据块（按 offset 的字节流）、段完成/失败事件 |
| **实现要点** | 连接池 per 任务；每连接绑定当前段；段完成后回调调度器，再取新段或“帮慢连接”；超时重试本段或重新分配；支持暂停时优雅断开 |
| **接口形态** | Rust 内部模块，依赖“协议与网络”的 HTTP 客户端 |

#### 2.2.5 磁盘写入（Writer）

| 项目 | 内容 |
|------|------|
| **职责** | 按 offset 将各段数据写入目标文件，避免多线程写同一文件冲突 |
| **输入** | (offset, bytes) 或 (segment_id, bytes) + 已知 offset |
| **输出** | 写入成功/失败；可选：写入进度（已写字节） |
| **实现要点** | 预分配文件（按总大小）或按段追加临时文件最后合并；多线程写时每个段固定 offset，无重叠；考虑顺序写或随机写对磁盘的影响，可做简单队列 |
| **接口形态** | Rust 内部模块，由连接管理在收到一段数据时调用 |

#### 2.2.6 进度持久化（Persistence）

| 项目 | 内容 |
|------|------|
| **职责** | 周期性保存“未完成区间”、任务元数据（URL、路径、添加时间）；恢复时反序列化 |
| **输入** | 任务 ID、未完成区间列表、元数据、保存触发（定时/暂停/退出） |
| **输出** | 持久化文件（如 JSON 或 SQLite）；恢复时返回可恢复任务列表及未完成区间 |
| **实现要点** | 未完成区间用 [start, end) 列表，合并相邻、去重叠；保存频率可配置（如每 30s 或每 10%）；退出时同步写一次 |
| **接口形态** | Rust 内部模块；恢复后由调度器 resume 任务 |

### 2.3 引擎层对外接口（Tauri Commands 建议）

| Command | 说明 |
|---------|------|
| `probe_download` | 协议探测，返回是否可多连接、大小、建议文件名 |
| `create_download` | 创建任务（URL、保存路径、可选文件名、可选 header） |
| `pause_download` | 暂停指定任务 |
| `resume_download` | 恢复指定任务 |
| `cancel_download` | 取消并删除任务（可选删文件） |
| `list_downloads` | 返回任务列表及状态、进度、速度 |
| `get_download_progress` | 单任务进度详情（已下载、总大小、速度、剩余时间） |

### 2.4 依赖与数据流

- **依赖**：协议与网络（HTTP 客户端）。
- **数据流**：Probe → Create Task → Scheduler 驱动 → Segmentation 分配段 → Connection Manager 发 Range 请求 → 收到数据 → Writer 写盘；Persistence 定时/事件驱动写进度；前端通过 invoke + 事件拿到状态与进度。

---

## 三、协议与网络（Network）

### 3.1 模块职责

提供可靠的 HTTP(S) 客户端能力：Range 请求、重定向、Cookie、代理、认证，并统一 SSL 与错误处理。

### 3.2 子模块拆解

#### 3.2.1 HTTP/HTTPS 客户端

| 项目 | 内容 |
|------|------|
| **职责** | 发送 GET/HEAD、支持 Range、处理 206/200、重定向、读取 body 流 |
| **实现要点** | Rust: `reqwest` 或 `ureq`；需支持 stream 按块读取；重定向次数限制；Cookie 存储与回带 |
| **接口** | 供引擎 Probe 与 Connection Manager 调用：`request_range(url, range, headers) -> Stream<Result<Bytes>>` 等 |

#### 3.2.2 认证（Auth）

| 项目 | 内容 |
|------|------|
| **职责** | Basic、Digest、Bearer、NTLM（可选）等；弹窗或配置中保存用户名密码 |
| **实现要点** | 由 HTTP 客户端根据 401 或预配置添加 Authorization 头；敏感信息存系统钥匙串或加密配置 |
| **接口** | 在请求选项中传入 credentials 或由客户端自动从配置读取 |

#### 3.2.3 代理（Proxy）

| 项目 | 内容 |
|------|------|
| **职责** | 系统代理或手动配置 HTTP/SOCKS5 代理 |
| **实现要点** | reqwest 支持 proxy；可从环境变量或设置页读取 |
| **接口** | 创建 client 时注入 proxy 配置 |

#### 3.2.4 SSL / 证书

| 项目 | 内容 |
|------|------|
| **职责** | 证书校验；可选“忽略证书错误”（仅开发或用户明确同意） |
| **实现要点** | 默认严格校验；设置项 `dangerously_insecure_skip_verify` 时仅用于特殊环境 |
| **接口** | Client 构建时配置 |

### 3.3 与引擎的边界

- 协议与网络层**不**关心“任务、段、进度”，只提供“发请求、读响应体”。
- 引擎层负责：发哪些 Range、重试几次、超时时间、是否用代理（从任务或全局配置读）。

---

## 四、用户界面（UI）

### 4.1 模块职责

提供主窗口、新建任务、任务列表与进度展示、设置、通知与托盘，并调用 Tauri 命令与事件与后端交互。

### 4.2 子模块拆解

#### 4.2.1 主界面（任务列表）

| 项目 | 内容 |
|------|------|
| **职责** | 展示进行中/已完成/失败/已暂停任务；每行：文件名、进度条、速度、剩余时间、状态、操作（暂停/继续/取消/打开目录） |
| **实现要点** | React 列表/表格；通过 Tauri 事件或轮询更新进度；虚拟列表应对大量任务 |
| **技术** | `invoke('list_downloads')`、监听 `download-progress` 等事件 |

#### 4.2.2 新建任务（Add Task）

| 项目 | 内容 |
|------|------|
| **职责** | 输入 URL；可选保存路径、重命名；可选“先探测”显示大小与建议文件名 |
| **实现要点** | 对话框或侧栏；先 `probe_download` 再填默认路径与文件名；支持拖拽/粘贴 URL |
| **技术** | `invoke('probe_download')`、`invoke('create_download')` |

#### 4.2.3 设置（Settings）

| 项目 | 内容 |
|------|------|
| **职责** | 默认保存路径、每任务最大连接数、全局最大并发任务数、超时、代理、是否开机启动、通知开关等 |
| **实现要点** | 表单持久化；Rust 侧用 tauri-plugin-store 或写配置文件；前端读/写通过 command |
| **技术** | `invoke('get_settings')`、`invoke('set_settings')` 或 store 插件 |

#### 4.2.4 通知与托盘（Notification & Tray）

| 项目 | 内容 |
|------|------|
| **职责** | 任务完成/失败时系统通知；托盘图标、最小化到托盘、右键菜单（显示/退出） |
| **实现要点** | Tauri 的 tray 与 notification API；可选声音 |
| **技术** | `@tauri-apps/plugin-notification`、Tray 与 Window 配置 |

### 4.3 前端与后端边界

- 前端**只**通过 Tauri 的 `invoke` 与**事件**与后端通信；不直接操作文件或网络。
- 后端负责所有下载逻辑与持久化；前端只负责展示与用户操作转发。

---

## 五、浏览器集成（Integration）

### 5.1 模块职责

从浏览器捕获下载链接并发送给主程序，实现“用 Multidown 下载”的体验。

### 5.2 子模块拆解

#### 5.2.1 浏览器扩展（Extension）

| 项目 | 内容 |
|------|------|
| **职责** | 拦截或监听页面中的下载链接；提供右键菜单“使用 Multidown 下载”；可选：批量选中链接发送 |
| **实现要点** | Chrome/Firefox/Edge 扩展；通过 Native Messaging 与本地主程序通信；主程序需提供 Native Host（如 JSON 脚本指向 exe） |
| **技术** | 扩展：JS；Host：Rust 或独立小 exe，读 stdin 写 stdout 按 Native Messaging 协议 |

#### 5.2.2 捕获规则（Rules）

| 项目 | 内容 |
|------|------|
| **职责** | 仅对特定类型（扩展名、MIME）或域名进行接管，避免误拦 |
| **实现要点** | 扩展侧：可配置白名单/黑名单；主程序侧：可拒绝非法或重复 URL |
| **技术** | 配置存在主程序，扩展请求时由主程序校验 |

#### 5.2.3 高级集成（无扩展场景）

| 项目 | 内容 |
|------|------|
| **职责** | 不支持扩展的浏览器：自定义 URL Scheme（如 `multidown://add?url=...`）、剪贴板监听、监控系统下载目录等 |
| **实现要点** | 注册协议关联；或提供“复制链接后点击托盘添加”的快捷方式 |
| **技术** | 操作系统级配置 + Tauri 处理协议打开 |

### 5.3 实现优先级建议

- P1：先做**单端扩展**（如 Chrome）+ Native Messaging Host，验证“点击 → 主程序添加任务”闭环。
- P2：再加捕获规则与其它浏览器/Edge。
- P3：URL Scheme 与剪贴板等高级集成。

---

## 六、扩展能力（Extensions）

### 6.1 模块职责

在核心下载之上提供批量、规则、定时、分类等增强功能，用于差异化体验。

### 6.2 子模块拆解

#### 6.2.1 批量下载（Batch）

| 项目 | 内容 |
|------|------|
| **职责** | 从文本/网页/ sitemap 批量添加 URL；支持命名模板（序号、原文件名）与去重 |
| **实现要点** | 解析输入为 URL 列表；可调 `create_download` 循环或批量 API；前端：文本框粘贴、文件上传、输入规则（如 URL 模板） |
| **技术** | Rust: 批量任务创建 + 可选队列限流；前端：批量表单与进度汇总 |

#### 6.2.2 分类与规则（Category & Rules）

| 项目 | 内容 |
|------|------|
| **职责** | 按扩展名、域名、MIME 等规则自动选择保存目录；可选默认分类（视频/压缩包/文档等） |
| **实现要点** | 规则引擎在 Rust；新建任务时根据 URL 或 Probe 结果匹配规则，改写保存路径 |
| **技术** | 配置：规则列表（条件 + 目标路径）；在 `create_download` 前或内部应用 |

#### 6.2.3 定时与计划（Schedule）

| 项目 | 内容 |
|------|------|
| **职责** | 定时开始下载、指定时段限速、暂停时段 |
| **实现要点** | 调度器考虑“计划开始时间”；限速在连接层或全局令牌桶 |
| **技术** | Rust: 定时器 + 任务状态“计划中”；设置页： cron 或简单时间选择 |

#### 6.2.4 视频/流媒体（可选）

| 项目 | 内容 |
|------|------|
| **职责** | 从部分站点解析视频直链并加入下载（非通用协议） |
| **实现要点** | 需按站点定制的解析逻辑；可作为独立插件或后期功能 |
| **技术** | 单独模块，输入页面 URL，输出媒体 URL，再走普通下载流程 |

### 6.3 实现优先级建议

- P2：**批量下载**、**分类与规则**（提升日常使用体验）。
- P3：定时/计划、视频解析（按需求再上）。

---

## 七、实现阶段建议（与文档一致）

| 阶段 | 内容 | 对应模块 |
|------|------|----------|
| **一** | 多连接 + 静态分段 + 断点续传；最小 UI（列表 + 新建 + 暂停/继续） | 下载引擎、协议与网络、UI 主界面与新建任务 |
| **二** | 动态分段 + 连接复用；进度持久化与恢复；设置页 | 引擎分段与连接、持久化；UI 设置 |
| **三** | 浏览器扩展 + Native Host；通知与托盘 | 浏览器集成、UI 通知与托盘 |
| **四** | 批量、规则、定时等 | 扩展能力 |

---

## 八、文档索引

- [IDM 核心原理与功能模块分析](./IDM核心原理与功能模块分析.md) — 原理与对标分析
- [技术栈选型分析](./技术栈选型分析.md) — Tauri 2 选型说明
- **本文档** — 功能模块单独整理与实现参考
