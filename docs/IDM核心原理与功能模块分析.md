# IDM（Internet Download Manager）核心原理与功能模块分析

> 面向「对标 IDM 的下载工具」开发的分析文档

---

## 一、核心原理概览

IDM 的加速本质是：**在服务器支持的前提下，用多连接 + 动态分段 + 断点续传，把单连接的带宽瓶颈拆成多路并行，并尽量让每条连接都“有事可做”。**

### 1.1 为什么能加速？

| 对比项 | 传统单线程下载 | IDM 多连接下载 |
|--------|----------------|----------------|
| 连接数 | 1 个 TCP 连接 | 4～8（可配置）个并行连接 |
| 请求方式 | 顺序下载整文件 | 每个连接只请求一段（Range） |
| 带宽利用 | 受单连接拥塞/限速影响 | 多连接分摊，更易吃满带宽 |
| 断点续传 | 需服务器支持 Range | 同样依赖 Range，但按“段”记录进度 |

前提条件：**服务器必须支持 HTTP Range 请求**（返回 `Accept-Ranges: bytes`，对 Range 请求返回 206 Partial Content）。否则只能单连接顺序下载，无法分段、无法断点续传。

### 1.2 协议基础：HTTP Range（RFC 7233）

- **探测支持**：发 `HEAD` 或带 `Range: bytes=0-` 的 `GET`，看是否返回 `206` 和 `Content-Range` / `Accept-Ranges: bytes`。
- **请求某一段**：`Range: bytes=start-end`，例如 `Range: bytes=0-1023` 表示前 1024 字节。
- **响应**：`206 Partial Content`，`Content-Range: bytes start-end/total`，body 仅为该段数据。
- **不支持时**：服务器忽略 Range，返回 `200` 和完整内容，此时只能单连接、不能暂停/续传。

---

## 二、IDM 的两大核心技术

### 2.1 动态分段（Dynamic Segmentation）

**和“静态分段”的对比：**

- **静态分段**：一开始就把文件按固定大小切成 N 段（如 8 段），每段固定起止位置，容易导致有的连接先下完闲置、有的连接还很长，负载不均。
- **动态分段（IDM 做法）**：文件不在一开始就固定切死，而是用 **“对半切”** 的规则动态生成段：
  - 当 **新连接可用** 时：在所有“未下载的区间”里找 **当前最大的一段**，把这一段 **从中间对半拆开**，新连接从“中点”开始下载后半段，原连接（或原有逻辑）继续负责前半段。
  - 这样始终让 **最大的未完成段** 被拆开，新连接很快就有事做，减少“等段”和与服务器的反复协商。

**效果：**

- 连接数可以逐步打开（例如先 2 个再 4 个再 8 个），不必一开始就定死 8 段。
- 先完成任务的连接可以马上接手“新拆出来的半段”，或帮助其他慢连接（把别人最大的段对半切一块过来），**连接复用、负载更均衡**。
- 官方说明：通过“对半切 + 连接复用”，减少与服务器的协商次数，并尽量让所有连接都处于工作状态。

**实现要点（对标时必备）：**

- 维护一个“未下载区间”的集合（例如按 `[start, end)` 的列表或区间树）。
- “找最大未下载段” + “从中间一分为二” + “把新段分配给空闲连接”。
- 每个连接只知道自己当前的 `[start, end)`，用 HTTP `Range: bytes=start-(end-1)` 请求。

### 2.2 连接复用（Connection Reuse）

- 当 **连接 A 已经下完自己当前段** 时：
  - 若存在“已分配但还没开始下载”的段（例如连接 B 还没连上），可以把该段 **直接转给 A**，无需新建连接。
  - 若没有这种“未开始的段”，则 A 去 **帮助最慢的连接**：把该连接当前最大未完成段 **对半切**，A 下载其中一半。
- 这样避免“连接空闲、却再开新连接”的浪费，也减少重复的 TCP/SSL 握手和 HTTP 认证。

**实现要点：**

- 每个连接有状态：空闲 / 正在下载某段 / 已分配段尚未开始。
- 全局调度器：某连接变为空闲时，先查“是否有未开始的段可分配”，没有再执行“对半切 + 帮慢连接”。

---

## 三、断点续传与持久化

- IDM 会 **周期性保存进度**（例如每分钟多次），包括：
  - 已完成的段区间（或等价的“未完成区间”）
  - 当前动态分段生成的所有“起点”（即每个段的 start，对应官方图中粉色线）
- 暂停或意外退出后，下次 **Resume**：
  - 读入保存的区间信息，重新构建“未下载区间”集合。
  - 可重新应用“动态分段 + 连接复用”逻辑，无需从头开始。

**实现要点：**

- 持久化结构要能表达“哪些区间已写完、哪些未写”（例如区间列表 + 临时文件或数据库）。
- 支持“未完成区间”的合并与规范化，避免重叠或空洞。

---

## 四、功能模块拆解（对标产品可照此划分）

> **独立文档**：功能模块的完整整理、子模块职责、接口建议与实现优先级见 **[功能模块](./功能模块.md)**。

### 4.1 下载引擎（Core）

| 子模块 | 职责 | 技术要点 |
|--------|------|----------|
| 协议探测 | 判断是否支持 Range、获取文件大小、文件名 | HEAD/GET + 看 206、Accept-Ranges、Content-Length、Content-Disposition |
| 任务调度 | 创建/暂停/恢复/取消任务，管理连接数 | 任务队列、状态机、最大并发连接数限制 |
| 分段策略 | 静态 or 动态分段，段大小/数量策略 | 动态分段：未完成区间 + 对半切 + 找最大段 |
| 连接管理 | 多连接创建、分配段、复用、超时重试 | 连接池、每连接当前 Range、超时与重试策略 |
| 磁盘写入 | 按段写入、避免同一文件多线程写冲突 | 预分配文件 + 按 offset 写入；或临时段文件最后合并 |
| 进度持久化 | 保存/恢复未完成区间与元数据 | 序列化区间列表 + 元数据（URL、路径、时间等） |

### 4.2 协议与网络

| 子模块 | 职责 | 技术要点 |
|--------|------|----------|
| HTTP/HTTPS | 发 Range 请求、处理 206、重定向、Cookie | HTTP 客户端（如 libcurl、WinHTTP、或各语言成熟库） |
| 认证 | Basic / Digest / NTLM 等 | 按服务器要求带 Authorization 头或弹窗 |
| 代理 | 系统代理 / 自定义代理 | 支持 HTTP/SOCKS 代理 |
| SSL | 证书校验、可配置忽略/严格模式 | 与 HTTP 库一致 |

### 4.3 浏览器集成（可选但重要）

| 子模块 | 职责 | 技术要点 |
|--------|------|----------|
| 扩展/插件 | 捕获页面中的下载链接、右键“用 XX 下载” | Chrome Extension、Firefox Add-on、Edge 等；与本地进程通信（Native Messaging 或本地 HTTP） |
| 高级集成 | 不支持扩展的浏览器，通过 Hook 或全局监听 | 如监听剪贴板、监控下载目录、或系统级协议关联（自定义 URL Scheme） |
| 捕获规则 | 只接管特定类型/域名 | 按 MIME、扩展名、域名白名单/黑名单 |

### 4.4 用户界面与体验

| 子模块 | 职责 | 技术要点 |
|--------|------|----------|
| 主界面 | 任务列表、进度、速度、剩余时间 | 列表/表格、进度条、实时刷新 |
| 新建任务 | 输入 URL、选择路径、重命名、可选代理 | 对话框、历史路径、文件名从 Content-Disposition 解析 |
| 设置 | 连接数、超时、默认路径、代理、协议选项 | 持久化配置（INI/JSON/注册表等） |
| 通知 | 完成/失败提示、声音、托盘 | 系统通知、托盘图标、可选声音 |

### 4.5 扩展能力（差异化）

| 子模块 | 职责 | 技术要点 |
|--------|------|----------|
| 批量下载 | 从文本/网页批量添加 URL | 解析规则、去重、命名模板（序号、原文件名等） |
| 视频/流媒体 | 从部分站点抓取视频链接 | 需针对站点解析（非通用协议，可作为扩展功能） |
| 定时/计划 | 定时开始、限速时段 | 调度器、速度限制 |
| 分类与规则 | 按类型/域名自动分目录 | 规则引擎 + 默认保存路径 |

---

## 五、技术实现要点小结

### 5.1 必须实现的“最小闭环”

1. **探测 Range 支持**：HEAD 或 GET 带 Range，根据 206 和 `Accept-Ranges` 决定是否多连接。
2. **多连接 + Range 请求**：每个连接只请求一段 `bytes=start-end`，写入文件对应 offset。
3. **断点续传**：持久化“已完成区间”，恢复时只请求未完成区间（可先做静态分段，再升级动态分段）。
4. **任务与队列**：单个任务内多连接、多任务间并发数限制，避免把系统或服务器拉爆。

### 5.2 进阶（对标 IDM 体验）

1. **动态分段 + 连接复用**：未完成区间 + 对半切 + 空闲连接帮慢连接，逻辑见第二节。
2. **周期性保存进度**：几分钟内多次写入进度文件，崩溃/断电后也能续传。
3. **浏览器扩展 + 主程序通信**：扩展抓链接，主程序接单并添加任务。
4. **友好 UI**：速度曲线、剩余时间、按任务/全局限速等。

### 5.3 参数与调优（参考 IDM）

- **连接数**：常用 4～8，过高可能被服务器限速或封禁，且增加本地开销。
- **超时**：按网络类型设置连接/读取超时，避免长时间挂死。
- **重试**：某段失败可重试该段或重新分配段（动态分段下可把该段再对半切给其他连接）。

---

## 六、与你项目的对应关系（multidown）

若你的项目名为 **multidown**，可以按上述模块划分目录与职责，例如：

- `core/`：协议探测、任务调度、分段策略、连接管理、写入、持久化。
- `protocol/` 或 `network/`：HTTP/HTTPS 封装、代理、认证。
- `ui/`：主窗口、新建任务、设置、托盘。
- `integration/`：浏览器扩展或本地接收端（如 Native Messaging host）。
- `docs/`：本文档及后续设计文档。

先实现 **“多连接 + 静态分段 + 断点续传”** 的下载引擎，再逐步加入 **动态分段、连接复用、浏览器集成**，可以较快达到“对标 IDM 核心体验”的目标。

---

## 七、参考资料

- [RFC 7233 - Range Requests](https://httpwg.org/specs/rfc7233.html)
- [MDN - HTTP range requests](https://developer.mozilla.org/en-US/docs/Web/HTTP/Range_requests)
- [IDM 官方 - Dynamic Segmentation and Performance](https://www.internetdownloadmanager.com/support/segmentation.html)
- 本地文档：`docs/IDM核心原理与功能模块分析.md`（本文档）
